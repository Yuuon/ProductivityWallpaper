<Window x:Class="ProductivityWallpaper.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:ProductivityWallpaper.ViewModels"
        xmlns:views="clr-namespace:ProductivityWallpaper.Views"
        mc:Ignorable="d"
        Title="{Binding WindowTitle}" Height="600" Width="900"
        WindowStyle="None" AllowsTransparency="True" Background="Transparent"
        ResizeMode="CanResizeWithGrip">

    <WindowChrome.WindowChrome>
        <WindowChrome GlassFrameThickness="0" CornerRadius="10" CaptionHeight="40"/>
    </WindowChrome.WindowChrome>

    <!-- 关键修复：资源必须在使用之前定义，移到此处 -->
    <Window.Resources>
        <!-- Title Bar Button Style -->
        <Style x:Key="TitleButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#3E3E42"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Sidebar Menu Button Style -->
        <Style x:Key="MenuButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="#AAAAAA"/>
            <Setter Property="Height" Value="50"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Left" VerticalAlignment="Center" Margin="20,0,0,0"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#3E3E42"/>
                    <Setter Property="Foreground" Value="White"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>

    <Border Background="#2D2D30" CornerRadius="10" BorderBrush="#3E3E42" BorderThickness="1">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="40"/>
                <!-- Custom Title Bar -->
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="200"/>
                <!-- Sidebar -->
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Title Bar -->
            <Grid Grid.Row="0" Grid.ColumnSpan="2" MouseLeftButtonDown="TitleBar_MouseDown" Background="Transparent">
                <TextBlock Text="{DynamicResource AppTitle}" Foreground="#E1E1E1" VerticalAlignment="Center" Margin="15,0,0,0" FontWeight="Bold"/>

                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" WindowChrome.IsHitTestVisibleInChrome="True">
                    <Button Content="-" Width="40" Click="Minimize_Click" Style="{StaticResource TitleButtonStyle}"/>
                    <Button Content="X" Width="40" Click="Close_Click" Style="{StaticResource TitleButtonStyle}"/>
                </StackPanel>
            </Grid>

            <!-- Sidebar Navigation -->
            <StackPanel Grid.Row="1" Grid.Column="0" Background="#252526">
                <!-- 这里的 StaticResource 现在可以正确找到上方的 Style 了 -->
                <Button Content="{DynamicResource Menu_Wallpaper}" Command="{Binding NavigateToWallpaperCommand}" Style="{StaticResource MenuButtonStyle}"/>
                <Button Content="{DynamicResource Menu_AI}" Command="{Binding NavigateToAiToolCommand}" Style="{StaticResource MenuButtonStyle}"/>
                <Button Content="{DynamicResource Menu_Settings}" Command="{Binding NavigateToSettingsCommand}" Style="{StaticResource MenuButtonStyle}"/>
            </StackPanel>

            <!-- Main Content Area -->
            <!-- DataTemplates 依赖于类型编译。应用本修复后，请“重新生成解决方案”，类型错误通常会消失 -->
            <ContentControl Grid.Row="1" Grid.Column="1" Content="{Binding CurrentView}" Margin="20">
                <ContentControl.Resources>
                    <DataTemplate DataType="{x:Type vm:WallpaperViewModel}">
                        <views:WallpaperView/>
                    </DataTemplate>
                    <DataTemplate DataType="{x:Type vm:AiToolViewModel}">
                        <views:AiToolView/>
                    </DataTemplate>
                    <DataTemplate DataType="{x:Type vm:SettingsViewModel}">
                        <views:SettingsView/>
                    </DataTemplate>
                </ContentControl.Resources>
            </ContentControl>
        </Grid>
    </Border>
</Window>